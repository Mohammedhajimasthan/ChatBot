<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chatbot</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #020617, #0f172a);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}

.chat-container {
    width: 100%;
    max-width: 420px;
    background: #020617;
    padding: 18px;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
}

h2 {
    text-align: center;
    color: #fff;
    margin-bottom: 10px;
}

.chat-box {
    background: #fff;
    border-radius: 12px;
    padding: 10px;
    height: 360px;
    display: flex;
    flex-direction: column;
}

.messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    font-size: 14px;
}

.bot-msg,
.user-msg {
    padding: 8px 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    max-width: 85%;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
}

.bot-msg {
    background: #f1f5f9;
}

.user-msg {
    background: #38bdf8;
    align-self: flex-end;
}

.input-area {
    display: flex;
    gap: 6px;
    margin-top: 8px;
}

input[type="text"] {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    outline: none;
}

button, .icon-btn {
    padding: 8px 10px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: #38bdf8;
    font-weight: bold;
}

.icon-btn {
    background: #e5e7eb;
}

.clear-btn {
    margin-bottom: 8px;
    background: #ef4444;
    color: #fff;
    font-size: 12px;
}

input[type="file"] {
    display: none;
}
</style>
</head>

<body>

<div class="chat-container">
    <h2>Chatbot ðŸ¤–</h2>

    <!-- DELETE HISTORY BUTTON -->
    <button class="clear-btn" onclick="clearChat()">ðŸ—‘ Clear History</button>

    <div class="chat-box">
        <div id="messages" class="messages"></div>

        <div class="input-area">
            <label class="icon-btn">
                ðŸ“Ž
                <input type="file" accept="*/*">
            </label>

            <button class="icon-btn" onclick="startVoice()">ðŸŽ¤</button>

            <input type="text" id="userInput" placeholder="Type a message...">

            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script>
const messages = document.getElementById("messages");
const input = document.getElementById("userInput");

/* ðŸ§  Load memory */
let chatMemory = JSON.parse(localStorage.getItem("chatMemory")) || [];

/* Restore history */
chatMemory.forEach(m => renderMessage(m.text, m.role));

function renderMessage(text, role) {
    const div = document.createElement("div");
    div.className = role === "user" ? "user-msg" : "bot-msg";
    div.innerText = text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function saveMemory(role, text) {
    chatMemory.push({ role, text });
    if (chatMemory.length > 20) chatMemory.shift();
    localStorage.setItem("chatMemory", JSON.stringify(chatMemory));
}

async function sendMessage() {
    if (!input.value.trim()) return;

    const userText = input.value;
    input.value = "";

    renderMessage(userText, "user");
    saveMemory("user", userText);

    let context = "Conversation so far:\n";
    chatMemory.forEach(m => {
        context += `${m.role}: ${m.text}\n`;
    });
    context += "\nRespond naturally to the latest message.";

    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: context })
        });

        const data = await res.json();
        renderMessage(data.response, "bot");
        saveMemory("bot", data.response);

    } catch {
        renderMessage("Server error.", "bot");
    }
}

/* Enter key */
input.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
});

/* Voice input */
function startVoice() {
    if (!("webkitSpeechRecognition" in window)) {
        alert("Voice not supported in this browser");
        return;
    }
    const rec = new webkitSpeechRecognition();
    rec.lang = "en-US";
    rec.start();
    rec.onresult = e => input.value = e.results[0][0].transcript;
}

/* ðŸ—‘ Clear chat history */
function clearChat() {
    if (!confirm("Delete entire chat history?")) return;
    messages.innerHTML = "";
    chatMemory = [];
    localStorage.removeItem("chatMemory");
}
</script>
</body>
</html>